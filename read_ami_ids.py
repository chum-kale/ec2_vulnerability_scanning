import boto3
import time

session = boto3.Session(profile_name = 'chum')
ec2 = session.client('ec2', region_name = 'us-east-1')

input_file_path = '/home/chinmay/work/ec2_vulnerability_scanning/ami_list.txt'

with open(input_file_path, 'r') as file:
    ami_ids = [line.strip() for line in file if line.strip()]

user_data_script = """#!/bin/bash
echo "Hello, EC2 User Data Script is running!"

# Update the package repositories and install software
sudo apt update -y
sudo apt install -y nginx

# Create a simple HTML file
cat <<EOL > /var/www/html/index.html
<!DOCTYPE html>
<html>
<head>
    <title>Hello from EC2</title>
</head>
<body>
    <h1>Hello from your EC2 instance!</h1>
</body>
</html>
EOL

# Start the Nginx web server
sudo systemctl start nginx

# Enable Nginx to start on boot
sudo systemctl enable nginx

echo "EC2 User Data Script completed."
"""

instance_params = {
    'ImageId': '',           
    'InstanceType': 't2.micro', 
    'MinCount': 1,
    'MaxCount': 1,
    'UserData': user_data_script,  
}

'''
il = 1
for ami_id in ami_ids:
    if il == 1:
        instance_params['ImageId'] = ami_id
        response = ec2.run_instances(**instance_params)
        #il += 1
        instance_id = response['Instances'][0]['InstanceId']
    else:
        break

if instance_id:
    time.sleep(100)
    ec2.stop_instances(InstanceIds = [instance_id])
'''

# Launch the instance
response = ec2.run_instances(**instance_params)
instance_id = response['Instances'][0]['InstanceId']

# Wait for a specific time (e.g., 100 seconds)
time.sleep(100)

# Stop the instance
ec2.stop_instances(InstanceIds=[instance_id])